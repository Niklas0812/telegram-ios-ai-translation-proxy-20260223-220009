name: Build Telegram IPA

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      apply_ai_patches:
        description: 'Apply AI translation patch series (disabled by default until patches are finalized)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  build-ipa:
    runs-on: macos-latest
    timeout-minutes: 360
    env:
      TELEGRAM_API_ID: TELEGRAM_API_ID_PLACEHOLDER
      TELEGRAM_API_HASH: TELEGRAM_API_HASH_PLACEHOLDER
      TELEGRAM_BUNDLE_ID: com.aitranslate.messenger
      TELEGRAM_APP_NAME: TranslateGram
      TELEGRAM_IOS_REPO: https://github.com/TelegramMessenger/Telegram-iOS.git
      TELEGRAM_IOS_REF: master
      APPLY_AI_PATCHES: "1"
    steps:
      - name: Checkout overlay repo
        uses: actions/checkout@v4

      - name: Override Telegram API placeholders from secrets (if provided)
        shell: bash
        run: |
          if [[ -n "${{ secrets.TELEGRAM_API_ID }}" ]]; then
            echo "TELEGRAM_API_ID=${{ secrets.TELEGRAM_API_ID }}" >> "$GITHUB_ENV"
          fi
          if [[ -n "${{ secrets.TELEGRAM_API_HASH }}" ]]; then
            echo "TELEGRAM_API_HASH=${{ secrets.TELEGRAM_API_HASH }}" >> "$GITHUB_ENV"
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.apply_ai_patches }}" == "false" ]]; then
            echo "APPLY_AI_PATCHES=0" >> "$GITHUB_ENV"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clone Telegram-iOS
        run: ./telegram_overlay/scripts/clone_telegram_ios.sh vendor/Telegram-iOS

      - name: Detect Xcode version from Telegram versions.json
        id: xcode
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path
          versions = Path('vendor/Telegram-iOS/versions.json')
          version = 'latest-stable'
          if versions.exists():
              try:
                  data = json.loads(versions.read_text())
                  candidates = []
                  if isinstance(data, dict):
                      for k, v in data.items():
                          if isinstance(v, str) and 'xcode' in k.lower():
                              candidates.append(v)
                          elif isinstance(v, dict):
                              for sk, sv in v.items():
                                  if isinstance(sv, str) and 'xcode' in sk.lower():
                                      candidates.append(sv)
                  if candidates:
                      version = candidates[0]
              except Exception:
                  pass
          print(f"xcode_version={version}")
          with open(Path('.github_xcode_output.txt'), 'w') as f:
              f.write(version)
          PY
          echo "xcode_version=$(cat .github_xcode_output.txt)" >> "$GITHUB_OUTPUT"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ steps.xcode.outputs.xcode_version }}
        continue-on-error: true

      - name: Apply overlay files and patches
        run: ./telegram_overlay/scripts/apply_overlay.sh vendor/Telegram-iOS

      - name: Configure Telegram build placeholders
        run: ./telegram_overlay/scripts/configure_telegram_build.sh vendor/Telegram-iOS

      - name: Prepare codesigning directory (verification fallback)
        working-directory: vendor/Telegram-iOS
        run: |
          set -euo pipefail
          if command -v brew >/dev/null 2>&1; then
            OPENSSL3_PREFIX="$(brew --prefix openssl@3 2>/dev/null || true)"
            if [[ -n "${OPENSSL3_PREFIX:-}" && -x "$OPENSSL3_PREFIX/bin/openssl" ]]; then
              export PATH="$OPENSSL3_PREFIX/bin:$PATH"
            fi
          fi
          echo "Using openssl at: $(command -v openssl)"
          openssl version || true
          echo "TELEGRAM_CODESIGNING_DIR=build-system/fake-codesigning" >> "$GITHUB_ENV"
          mkdir -p build-inputs/verification-codesigning/certs
          mkdir -p build-inputs/verification-codesigning/profiles
          cp -f build-system/fake-codesigning/certs/* build-inputs/verification-codesigning/certs/
          if python3 build-system/Make/Make.py \
            --overrideXcodeVersion \
            generate-verification-profiles \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --destination=build-inputs/verification-codesigning/profiles \
            --certsPath=build-system/fake-codesigning/certs
          then
            echo "TELEGRAM_CODESIGNING_DIR=build-inputs/verification-codesigning" >> "$GITHUB_ENV"
            echo "Using generated verification provisioning profiles"
          else
            echo "Verification profile generation failed; falling back to build-system/fake-codesigning"
          fi

      - name: Build Telegram-iOS IPA (release_arm64 verification)
        working-directory: vendor/Telegram-iOS
        run: |
          set -euo pipefail
          if command -v brew >/dev/null 2>&1; then
            OPENSSL3_PREFIX="$(brew --prefix openssl@3 2>/dev/null || true)"
            if [[ -n "${OPENSSL3_PREFIX:-}" && -x "$OPENSSL3_PREFIX/bin/openssl" ]]; then
              export PATH="$OPENSSL3_PREFIX/bin:$PATH"
            fi
          fi
          mkdir -p "$GITHUB_WORKSPACE/artifacts"
          python3 build-system/Make/Make.py \
            --overrideXcodeVersion \
            --cacheDir="$RUNNER_TEMP/telegram-bazel-cache" \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath="$TELEGRAM_CODESIGNING_DIR" \
            --buildNumber=100001 \
            --configuration=release_arm64 \
            --outputBuildArtifactsPath="$GITHUB_WORKSPACE/artifacts"
          if [[ -f "$GITHUB_WORKSPACE/artifacts/Telegram.ipa" ]]; then
            cp "$GITHUB_WORKSPACE/artifacts/Telegram.ipa" "$GITHUB_WORKSPACE/artifacts/TranslateGram-verification.ipa"
          fi

      - name: Locate app bundle (best-effort)
        id: appbundle
        run: |
          set -euo pipefail
          APP_PATH="$(find vendor/Telegram-iOS -type d -name '*.app' | head -n 1 || true)"
          if [[ -n "$APP_PATH" ]]; then
            echo "app_path=$APP_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "app_path=" >> "$GITHUB_OUTPUT"
          fi

      - name: Package IPA (best-effort)
        if: ${{ steps.appbundle.outputs.app_path != '' }}
        run: |
          mkdir -p artifacts
          ./telegram_overlay/scripts/package_unsigned_ipa.sh "${{ steps.appbundle.outputs.app_path }}" "$(pwd)/artifacts/TranslateGram.ipa"

      - name: Upload build artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: telegram-ios-build-artifacts
          path: |
            artifacts/**
            vendor/Telegram-iOS/build-inputs/**
          if-no-files-found: warn
